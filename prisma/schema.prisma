// This is your Prisma schema file for Peak Blooms E-Commerce
// Database schema for users, products, categories, orders, and shopping carts

generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

// NextAuth.js Models
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?  @db.Text
  access_token       String?  @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?  @db.Text
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Peak Blooms Models
model User {
  id            String     @id @default(cuid())
  email         String?    @unique
  emailVerified DateTime?
  name          String?
  image         String?
  role          Role       @default(CUSTOMER)
  approved      Boolean    @default(false)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  accounts      Account[]
  sessions      Session[]
  cart          ShoppingCart?
  orders        Order[]
}

enum Role {
  CUSTOMER
  ADMIN
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  image       String?
  description String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]
}

model InspirationSet {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  subtitle        String
  image           String
  excerpt         String    @db.Text
  inspirationText String    @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  products        InspirationSetProduct[]
}

model Product {
  id              String    @id @default(cuid())
  name            String
  slug            String    @unique
  description     String?   @db.Text
  image           String?
  color           String?
  categoryId      String
  featured        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  category        Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  cartItems       CartItem[]
  orderItems      OrderItem[]
  inspirationSets InspirationSetProduct[]
  variants        ProductVariant[]

  @@index([categoryId])
  @@index([slug])
}

// Explicit join table for InspirationSet <-> Product with variant support
model InspirationSetProduct {
  id                String           @id @default(cuid())
  inspirationSetId  String
  productId         String
  productVariantId  String?
  createdAt         DateTime         @default(now())

  inspirationSet    InspirationSet   @relation(fields: [inspirationSetId], references: [id], onDelete: Cascade)
  product           Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  productVariant    ProductVariant?  @relation(fields: [productVariantId], references: [id], onDelete: SetNull)

  @@unique([inspirationSetId, productId])
  @@index([inspirationSetId])
  @@index([productId])
}

model ProductVariant {
  id            String   @id @default(cuid())
  productId     String
  price         Float
  stemLength    Int?     @map("stem_length")
  countPerBunch Int?     @map("count_per_bunch")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  product                Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems              CartItem[]
  orderItems             OrderItem[]
  inspirationSetProducts InspirationSetProduct[]

  @@index([productId])
}

model ShoppingCart {
  id        String    @id @default(cuid())
  userId    String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
}

model CartItem {
  id        String    @id @default(cuid())
  cartId    String
  productId String
  quantity  Int       @default(1)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  cart      ShoppingCart @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  productVariant ProductVariant? @relation(fields: [productVariantId], references: [id], onDelete: SetNull)
  productVariantId String?

  @@unique([cartId, productId, productVariantId])
  @@index([cartId])
  @@index([productId])
}

model Order {
  id        String    @id @default(cuid())
  userId    String
  status    OrderStatus @default(PENDING)
  total     Float
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     OrderItem[]

  @@index([userId])
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  quantity  Int
  price     Float   // Price at time of purchase

  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: SetNull)
  productVariant ProductVariant? @relation(fields: [productVariantId], references: [id], onDelete: SetNull)
  productVariantId String?

  @@index([orderId])
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}
